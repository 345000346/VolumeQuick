name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  
jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Setup AutoHotkey
      uses: Zahni/Setup-AutoHotkey@main
      with:
        ahk-version: '2.0'
        
    - name: Compile AHK Script
      run: |
        # 使用AutoHotkey v2的编译器
        Copy-Item "C:\Program Files\AutoHotkey\v2\Compiler\Ahk2Exe.exe" -Destination "."
        .\Ahk2Exe.exe /in VolumeHotkey.ahk /out VolumeHotkey.exe
        
    - name: Get current date and commit info
      id: info
      shell: pwsh
      run: |
        $date = Get-Date -Format "yyyyMMdd"
        echo "DATE=$date" >> $env:GITHUB_OUTPUT
        
        $latestCommit = git log -1 --pretty=format:"%s"
        echo "COMMIT_MSG=$latestCommit" >> $env:GITHUB_OUTPUT
        
        # 简化的变更记录获取
        $changes = git log --oneline -10 --pretty=format:"- %s"
        echo "CHANGES<<EOF" >> $env:GITHUB_OUTPUT
        echo "$changes" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: VolumeHotkey${{ steps.info.outputs.DATE }}
        name: VolumeHotkey${{ steps.info.outputs.DATE }}
        body: |
          ## 更新内容
          ${{ steps.info.outputs.CHANGES }}
        files: VolumeHotkey.exe
        draft: false
        prerelease: false