name: Build and Release

on:
  push:
    branches: [ main, master ]  # 监听主分支推送
    tags:
      - 'v*'

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v2
      with:
        fetch-depth: 0  # 获取完整历史记录用于生成变更日志
    
    - name: Get current date and commit info
      id: info
      shell: pwsh
      run: |
        # 设置日期
        $date = Get-Date -Format "yyyyMMdd"
        "DATE=$date" | Out-File -FilePath $env:GITHUB_ENV -Append
        
        # 获取最新提交信息（转义特殊字符）
        $latestCommit = (git log -1 --pretty=format:"%B") -replace '"','\"' -replace "'","\'"
        echo "COMMIT_MSG=$latestCommit" | Out-File -FilePath $env:GITHUB_ENV -Append
        
        # 获取变更记录（转义特殊字符并限制长度）
        $lastTag = git describe --tags --abbrev=0 2>$null
        if ($lastTag) {
            $changes = git log "$lastTag..HEAD" --pretty=format:"- %s" | Select-Object -First 10
        } else {
            $changes = git log --pretty=format:"- %s" | Select-Object -First 10
        }
        $changes = ($changes -join "`n") -replace '"','\"' -replace "'","\'"
        echo "CHANGES<<EOF`n$changes`nEOF" | Out-File -FilePath $env:GITHUB_ENV -Append
    
    - name: Setup AutoHotkey
      shell: pwsh
      run: |
        # 首选从 GitHub Release 下载
        try {
          $ahkUrl = "https://github.com/AutoHotkey/AutoHotkey/releases/download/v2.0.11/AutoHotkey_2.0.11_setup.exe"
          Write-Host "正在从 GitHub 下载 AutoHotkey..."
          Invoke-WebRequest -Uri $ahkUrl -OutFile "ahk-setup.exe" -UseBasicParsing
        } catch {
          # 备用下载链接
          $backupUrls = @(
            "https://www.autohotkey.com/download/2.0/AutoHotkey_2.0.11_setup.exe",
            "https://ftp.autohotkey.com/AutoHotkey_2.0.11_setup.exe"
          )
          
          $success = $false
          foreach ($url in $backupUrls) {
            try {
              Write-Host "尝试备用下载链接: $url"
              Invoke-WebRequest -Uri $url -OutFile "ahk-setup.exe" -UseBasicParsing
              $success = $true
              break
            } catch {
              Write-Host "备用下载失败: $_"
              continue
            }
          }
          
          if (!$success) {
            throw "所有下载尝试均失败"
          }
        }
        
        # 安装 AHK
        Write-Host "正在安装 AutoHotkey..."
        Start-Process -FilePath "ahk-setup.exe" -ArgumentList "/S" -Wait
        
        # 验证安装
        $ahkPath = "C:\Program Files\AutoHotkey\v2"
        if (!(Test-Path $ahkPath)) {
          throw "AutoHotkey 安装验证失败"
        }
        Write-Host "AutoHotkey 安装成功"
    
    - name: Compile AHK Script
      shell: pwsh
      run: |
        $compiler = "C:\Program Files\AutoHotkey\v2\Compiler\Ahk2Exe.exe"
        $base = "C:\Program Files\AutoHotkey\v2\AutoHotkey64.exe"
        
        if (!(Test-Path $compiler)) {
            throw "找不到 AHK 编译器"
        }
        
        & $compiler /in "VolumeHotkey.ahk" /out "VolumeHotkey.exe" /icon "icon.ico" /base $base
        
        if (!(Test-Path "VolumeHotkey.exe")) {
            throw "编译失败：未生成 exe 文件"
        }
        
        New-Item -ItemType Directory -Path "release" -Force
        Copy-Item "VolumeHotkey.exe" -Destination "release\"
        Compress-Archive -Path "release\VolumeHotkey.exe" -DestinationPath "VolumeHotkey$env:DATE.zip" -Force
    
    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: build-${{ env.DATE }}
        name: VolumeHotkey Build ${{ env.DATE }}
        body: |
          ## 更新内容
          ${{ env.CHANGES }}
          
          ## 构建信息
          - 构建时间：${{ env.DATE }}
          - 分支：${{ github.ref_name }}
          - 提交：${{ github.sha }}
        files: VolumeHotkey${{ env.DATE }}.zip
        draft: false
        prerelease: false
