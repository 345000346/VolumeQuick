name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'

# 添加权限配置
permissions:
  contents: write
  packages: write
  
jobs:
  build:
    runs-on: windows-2022
    timeout-minutes: 15
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整历史记录用于生成变更日志
    
    - name: Get current date and commit info
      id: info
      shell: pwsh
      run: |
        try {
            Write-Host "正在获取日期..."
            $date = Get-Date -Format "yyyyMMdd"
            "DATE=$date" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "日期设置成功: $date"
            
            Write-Host "正在获取最新提交信息..."
            $latestCommit = git log -1 --pretty=format:"%B"
            if ($LASTEXITCODE -ne 0) { throw "获取提交信息失败" }
            
            $escapedCommit = $latestCommit -replace '"','\"' -replace "'","\'"
            "COMMIT_MSG=$escapedCommit" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "提交信息获取成功"
            
            Write-Host "正在获取变更记录..."
            $changes = @()
            # 获取最后一个编译版本的标签
            $lastBuildTag = git tag -l "VolumeHotkey*" | Sort-Object -Descending | Select-Object -First 1
            if ($lastBuildTag) {
                Write-Host "找到最新编译标签: $lastBuildTag"
                $changes = git log "$lastBuildTag..HEAD" --pretty=format:"- %s"
            } else {
                Write-Host "未找到编译标签，获取所有提交记录"
                $changes = git log --pretty=format:"- %s"
            }
            
            if ($changes.Count -eq 0) {
                $changes = @("- 无新增变更")
            }
            
            $escapedChanges = ($changes -join "`n") -replace '"','\"' -replace "'","\'"
            "CHANGES<<EOF`n$escapedChanges`nEOF" | Out-File -FilePath $env:GITHUB_ENV -Append
            Write-Host "变更记录获取成功"
            
        } catch {
            Write-Host "错误: $_"
            Write-Host "Stack Trace: $($_.ScriptStackTrace)"
            exit 1
        }
        
    - name: Install AutoHotkey v2
      shell: pwsh
      run: |
        $url = "https://github.com/Lexikos/AutoHotkey_L/releases/latest/download/AutoHotkey_2.0.21_setup.exe"
        Invoke-WebRequest -Uri $url -OutFile "AutoHotkey_setup.exe"
        Start-Process -FilePath ".\AutoHotkey_setup.exe" -ArgumentList "/S" -Wait

    - name: Compile AHK Script
      timeout-minutes: 5
      shell: pwsh
      run: |
        $ahk2exeCandidates = @(
          "$env:ProgramFiles\AutoHotkey\Compiler\Ahk2Exe.exe",
          "$env:ProgramFiles(x86)\AutoHotkey\Compiler\Ahk2Exe.exe"
        )

        $ahk2exe = $ahk2exeCandidates | Where-Object { Test-Path $_ } | Select-Object -First 1
        if (-not $ahk2exe) {
          throw "未找到 Ahk2Exe.exe，安装路径异常"
        }

        & $ahk2exe /in "VolumeHotkey.ahk" /out "VolumeHotkey.exe"
        if ($LASTEXITCODE -ne 0) {
          throw "Ahk2Exe 编译失败，退出码: $LASTEXITCODE"
        }

        if (-not (Test-Path "VolumeHotkey.exe")) {
          throw "编译完成后未找到 VolumeHotkey.exe"
        }
        
    - name: Create Release
      uses: softprops/action-gh-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: VolumeHotkey${{ env.DATE }}-${{ github.run_number }}-${{ github.run_attempt }}
        name: VolumeHotkey${{ env.DATE }}-${{ github.run_number }}-${{ github.run_attempt }}
        body: |
          ## 更新内容
          ${{ env.CHANGES }}
          
        files: VolumeHotkey.exe
        draft: false
        prerelease: false
