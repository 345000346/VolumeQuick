name: Build and Release

on:
  push:
    branches: [ main, master ]
    tags:
      - 'v*'

permissions:
  contents: write
  packages: write
  
jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install AutoHotkey v2
      run: |
        # Download and install AutoHotkey v2 from GitHub Releases to avoid Cloudflare protection
        $url = "https://github.com/Lexikos/AutoHotkey_L/releases/latest/download/AutoHotkey_2.0.16_setup.exe"
        Invoke-WebRequest -Uri $url -OutFile "AutoHotkey_setup.exe" -UseBasicParsing
        Start-Process -FilePath ".\AutoHotkey_setup.exe" -ArgumentList "/S" -Wait
        
    - name: Compile AHK Script
      run: |
        # Wait a moment for installation to complete
        Start-Sleep -s 5
        # Check for common installation paths
        $installPath = ""
        if (Test-Path "C:\Program Files\AutoHotkey\v2\") {
            $installPath = "C:\Program Files\AutoHotkey\v2\"
        } elseif (Test-Path "${env:USERPROFILE}\AppData\Local\Programs\AutoHotkey\") {
            $installPath = "${env:USERPROFILE}\AppData\Local\Programs\AutoHotkey\"
        } else {
            # Look for the installation path using Get-ChildItem
            $paths = Get-ChildItem "C:\Program Files\*" -Name -Directory | Where-Object { $_ -like "*AutoHotkey*" }
            if ($paths) {
                $installPath = "C:\Program Files\$($paths[0])\"
            }
        }
        
        if (!$installPath) {
            Write-Error "AutoHotkey installation directory not found!"
            Get-ChildItem "C:\" -Directory | Where-Object {$_.Name -like "*AutoHotkey*"} | Format-Table Name
            exit 1
        }
        
        Write-Output "Found AutoHotkey at: $installPath"
        
        # Verify installation
        $exePath = Join-Path $installPath "AutoHotkey64.exe"
        if (Test-Path $exePath) {
            & $exePath --version
        } else {
            Write-Error "AutoHotkey64.exe not found at expected location: $exePath"
            Get-ChildItem $installPath -Recurse -Name "*AutoHotkey*.exe" | Format-Table
            exit 1
        }
        
        # Find and copy Ahk2Exe compiler
        $compilerPath = Join-Path $installPath "Compiler\Ahk2Exe.exe"
        if (Test-Path $compilerPath) {
            Copy-Item $compilerPath -Destination "."
        } else {
            Write-Error "Ahk2Exe.exe not found at expected location: $compilerPath"
            Get-ChildItem $installPath -Recurse -Name "Ahk2Exe.exe" | ForEach-Object {
                $fullPath = Join-Path $installPath $_
                Write-Output "Found Ahk2Exe.exe at: $fullPath"
            }
            exit 1
        }
        
        # Compile the script
        .\Ahk2Exe.exe /in VolumeHotkey.ahk /out VolumeHotkey.exe
        
    - name: Get current date and commit info
      id: info
      shell: pwsh
      run: |
        $date = Get-Date -Format "yyyyMMdd"
        echo "DATE=$date" >> $env:GITHUB_OUTPUT
        
        $latestCommit = git log -1 --pretty=format:"%s"
        echo "COMMIT_MSG=$latestCommit" >> $env:GITHUB_OUTPUT
        
        # 简化的变更记录获取
        $changes = git log --oneline -10 --pretty=format:"- %s"
        echo "CHANGES<<EOF" >> $env:GITHUB_OUTPUT
        echo "$changes" >> $env:GITHUB_OUTPUT
        echo "EOF" >> $env:GITHUB_OUTPUT
        
    - name: Create Release
      uses: softprops/action-gh-release@v2
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: VolumeHotkey${{ steps.info.outputs.DATE }}
        name: VolumeHotkey${{ steps.info.outputs.DATE }}
        body: |
          ## 更新内容
          ${{ steps.info.outputs.CHANGES }}
        files: VolumeHotkey.exe
        draft: false
        prerelease: false